<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>Song Chords</title>
    <meta charset="utf-8">

    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="songchords.css">
    <meta name="theme-color" content="#db5945">

    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">


</head>

<body>
    <header class="toolbar">
        <span class="toolbar-settings button-edit">
            <button id="settings-toggle" class="settings-toggle" title="Settings">‚öô</button>
            <div id="settings-dropdown" class="settings-dropdown" hidden>
                <label for="textfontsize">Font size (px):
                    <input id="textfontsize" type="number" min="0" max="100">
                </label>
                <label for="chordfontsize">Chord delta size (px):
                    <input id="chordfontsize" type="number" min="-10" max="20">
                </label>
                <label for="chordcolor">Chord color:
                    <input id="chordcolor" type="color">
                </label>
                <label for="textcolor">Text color:
                    <input id="textcolor" type="color">
                </label>
                <label for="columncount">Columns:
                    <input id="columncount" type="number" min="1" max="5">
                </label>
                <label for="capo">Capo:
                    <input id="capo" type="number" min="-11" max="11">
                </label>
                <label for="notation">Notation:
                    <select id="notation">
                        <option value="">-</option>
                        <option value="b">‚ô≠</option>
                        <option value="#">‚ôØ</option>
                    </select>
                </label>
            </div>
        </span>

        <span class="button button-edit button-edit-only">
            Transpose:
            <button id="transposeMinus" title="Decrease half tone">-</button>
            <button id="transposePlus" title="Add half tone">+</button>
        </span>

        <span class="elastic"></span>
        <span class="button button-edit button-edit-print">
            <button id="print" title="Print (Ctrl-P)">üñ®</button></span>
        <span class="button button-edit button-edit-save">
            <button id="save" title="Save (Ctrl-S)">üíæ</button></span>
        <span class="button button-edit button-edit-gdownload">
            <button id="gDownload" title="Download">‚áÖ</button>
            <span id="gdrive-status" class="gdrive-status" title="Google Drive: disconnected"></span></span>
        <span class="button button-view-mode">
            <button id="readonly" title="View mode">üëÅ</button></span>
    </header>
    <main>
        <section class="song-write">
            <header class="chord-header">
                <input class="chord-name" id="chord-name" value="mySong">
                <select title="Song switcher" id="chord-select" style="display:none">
                    <option value="">-</option>
                    <option value="+">New song</option>
                </select>
                <button id="song-list-toggle" class="song-list-toggle" title="Song list">‚ò∞</button>
                <span class="button button-fixed button-delete">
                    <button title="Delete this song" id="delete">üóë</button>
                </span>
            </header>
            <textarea name="text" id="chord-area" spellcheck="false"></textarea>
        </section>
        <section class="song-render">
            <div class="song-render-inside" id="chord-render"></div>
        </section>
    </main>

    <div id="sync-toast" class="sync-toast" hidden>
        <div class="sync-toast-content">
            <span id="sync-toast-icon" class="sync-toast-icon"></span>
            <span id="sync-toast-message" class="sync-toast-message"></span>
        </div>
        <div id="sync-toast-progress" class="sync-toast-progress" hidden>
            <div id="sync-toast-bar" class="sync-toast-bar"></div>
        </div>
    </div>

    <div id="song-list-overlay" class="song-list-overlay" hidden>
        <div class="song-list-panel">
            <div class="song-list-header">
                <div id="song-list-group-filter" class="song-list-group-filter"></div>
                <div class="song-list-header-row">
                    <input type="search" id="song-list-search" class="song-list-search" placeholder="Filter songs‚Ä¶" autocomplete="off">
                    <button id="song-list-close" class="song-list-close" title="Close">√ó</button>
                </div>
            </div>
            <ul id="song-list-items" class="song-list-items"></ul>
            <div class="song-list-footer" id="song-list-footer">
                <button id="song-list-new" class="song-list-new">+ New song</button>
                <button id="song-list-web-search" class="song-list-new">üîç Search on web</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <a href="privacy.html">Privacy Policy</a> ¬∑ <a href="terms.html">Terms of Service</a>
    </footer>

    <div id="web-search-overlay" class="song-list-overlay" hidden>
        <div class="song-list-panel web-search-panel">
            <div class="song-list-header">
                <div class="song-list-header-row">
                    <input type="search" id="web-search-input" class="song-list-search"
                           placeholder="Song title or artist‚Ä¶" autocomplete="off">
                    <button id="web-search-btn" class="web-search-btn" title="Search">üîç</button>
                    <button id="web-search-close" class="song-list-close" title="Close">√ó</button>
                </div>
            </div>
            <div id="ug-credentials-form" class="ug-credentials-form" hidden>
                <p>Connectez-vous avec votre compte Ultimate Guitar</p>
                <input type="text" id="ug-username" placeholder="Email" autocomplete="username">
                <input type="password" id="ug-password" placeholder="Mot de passe" autocomplete="current-password">
                <button id="ug-credentials-save">Se connecter</button>
            </div>
            <div id="web-search-status" class="web-search-status" hidden></div>
            <ul id="web-search-results" class="song-list-items"></ul>
            <div class="web-search-footer">
                <button id="ug-logout" class="ug-logout" hidden>D√©connexion UG</button>
            </div>
        </div>
    </div>

</body>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }
</script>
<script type="module" src="songchords.js"></script>
<script type="module" src="websearch.js"></script>
<script type="module" src="g/sync.js"></script>

<script type="text/javascript">
    /* exported gapiLoaded */
    /* exported gisLoaded */
    /* exported handleAuthClick */
    /* exported handleSignoutClick */

    // Discovery doc URL for APIs used by the quickstart
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let CLIENT_ID = '';
    let API_KEY = '';
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let configLoaded = false;

    document.getElementById('gDownload').style.visibility = 'hidden';

    // Fetch API keys from Netlify Function
    fetch('/api/config')
        .then(r => r.json())
        .then(cfg => {
            CLIENT_ID = cfg.googleClientId;
            API_KEY = cfg.googleApiKey;
            configLoaded = true;
            maybeEnableButtons();
        })
        .catch(err => console.warn('Could not load config:', err));

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializeGapiClient() {
        if (!API_KEY) {
            gapiInited = 'pending';
            return;
        }
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
        if (!CLIENT_ID) {
            gisInited = 'pending';
            return;
        }
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
    }

    /**
     * Enables user interaction after all libraries are loaded.
     */
    async function maybeEnableButtons() {
        if (!configLoaded) return;
        if (gapiInited === 'pending') {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
        }
        if (gisInited === 'pending') {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
        }
        if (gapiInited === true && gisInited === true) {
            document.getElementById('gDownload').style.visibility = 'visible';
        }
    }

</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</html>